---
import { cn } from '@/lib/utils'
import type { RoleType } from '@/pixi/role'

import EntityIcon from '@/components/EntityIcon.astro'

import any from '/pixi/role/any.png?url'
import all from '/pixi/role/all.png?url'
import tank from '/pixi/role/tank.png?url'
import healer from '/pixi/role/healer.png?url'
import dps from '/pixi/role/dps.png?url'
import melee from '/pixi/role/melee.png?url'
import ranged from '/pixi/role/ranged.png?url'
import magic from '/pixi/role/magic.png?url'
import boss from '/pixi/enemy/061712.png?url'
import enemy_level1 from '/pixi/enemy/061707.png?url'

interface Props {
  role: RoleType
  tag?: 'MT' | 'ST' | 'OT' | 'H1' | 'H2' | 'D1' | 'D2' | 'D3' | 'D4' | 'BOSS' | string
  class?: string
}

const tagHandler = (tag: string): string => {
  // 添加文本使攻略行文通顺
  if (['最近', '最远'].includes(tag)) return `${tag}目标`
  else return tag
}

const { role = 'any', tag = '', class: className = '' }: Props = Astro.props
const img = {
  any,
  all,
  tank,
  healer,
  dps,
  melee,
  ranged,
  magic,
  boss,
  enemy_level1,
}[role]
const text =
  tagHandler(tag) ||
  {
    any: '全员',
    all: '任一角色',
    tank: 'T',
    healer: 'H',
    dps: 'D',
    melee: '近战',
    ranged: '远敏',
    magic: '法系',
    boss: '', // 敌对生物slot都包含名称，直接隐藏图标
    enemy_level1: '',
  }[role]
---

<EntityIcon icon={img} tag={tag} alt={tag ?? role} class={cn(className, 'standard-role-icon')}>
  <slot />
</EntityIcon>
<div class={cn(className, 'minimal-role-icon')}>{text}<slot /></div>

<script>
  import { subscribeKeys } from 'nanostores'

  import { $stratSettings } from '@/stores/stratSettings'

  subscribeKeys($stratSettings, ['readModeSetting'], (stratSettings) => {
    // 切换阅读模式
    const isMinimal = stratSettings.readModeSetting === 'minimal'
    document.querySelectorAll<HTMLElement>('.standard-role-icon').forEach((e) => {
      e.style.display = isMinimal ? 'none' : ''
    })
    document.querySelectorAll<HTMLElement>('.minimal-role-icon').forEach((e) => {
      e.style.display = isMinimal ? '' : 'none'
    })
  })
</script>
